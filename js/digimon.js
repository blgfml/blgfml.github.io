(()=>{class e{constructor(){var e=window.DigimonData;if(!e)return console.error("Data Missing");this.requirements=e.requirements,this.petLines=e.petLines,this.skins=e.skins,this.skinNames=e.skinNames.map(e=>e.toUpperCase()),this.maps=e.maps||[],this.sfxData=e.sfx||{},this.currentBGM=null,this.currentBGMUrl="",this.audioUnlocked=!1,this.audioSettings={bgm:!0,sfx:!0},this.soundMenuIndex=0,this.phases=["PHASE_0","PHASE_1","PHASE_2","PHASE_3","PHASE_4","PHASE_5","PHASE_6","PHASE_7"],this.currentPetIndex=0,this.currentTree=this.petLines[0].tree,this.currentDigimon=this.currentTree.PHASE_0[0],this.currentPhaseImages=this.currentDigimon.images,this.currentPhaseIndex=0,this.petStats={wpm:0,accuracy:0},this.gameState="GAME",this.isPlaying=!0,this.totalSeconds=0,this.timeAtLastEvolution=0,this.menuOptions=["ADVENTURE","PARTNER","TRAIN","SKIN","SOUND"],this.menuIndex=0,this.skinSelectionIndex=0,this.petSelectionIndex=0,this.selectedMapIndex=0,this.selectedLevelIndex=0,this.currentEnemy=null,this.typingTarget="",this.typingIndex=0,this.typingTimer=0,this.typingCorrectChars=0,this.typingTotalChars=0,this.wordParts=["DATA","CORE","NET","WEB","LINK","CODE","GIGA","MEGA","TERA","BYTE","NEO","ZERO","VIRUS","FILE","SCAN"],this.isTrainingMode=!0,this.isMenuAnimating=!1,this.frameIndex=0,this.animationInterval=null,this.timerInterval=null,this.evolutionPending=!1,this.els={container:document.getElementById("digimon-container"),screen:document.querySelector(".screen-layer"),img:document.getElementById("pet-img"),msg:document.getElementById("msg-display"),time:document.getElementById("time-display"),modal:document.getElementById("evolve-modal"),menuOverlay:document.getElementById("menu-overlay"),input:document.getElementById("virtual-keyboard")},document.getElementById("vs-screen")||((e=document.createElement("div")).id="vs-screen",e.innerHTML='<img id="vs-player" class="vs-sprite" src=""><div class="vs-text">VS</div><img id="vs-enemy" class="vs-sprite" src="">',document.querySelector(".screen-layer").appendChild(e),this.els.vsScreen=e,this.els.vsPlayer=document.getElementById("vs-player"),this.els.vsEnemy=document.getElementById("vs-enemy")),document.getElementById("btn-up").addEventListener("click",()=>this.handleUpInput()),document.getElementById("btn-down").addEventListener("click",()=>this.handleDownInput()),document.getElementById("btn-a").addEventListener("click",()=>this.handleRightTopInput()),document.getElementById("btn-b").addEventListener("click",()=>this.handleRightBottomInput());let t=()=>{this.unlockAudio(),document.removeEventListener("click",t),document.removeEventListener("keydown",t)};document.addEventListener("click",t),document.addEventListener("keydown",t),this.els.input&&(this.els.input.addEventListener("input",e=>this.handleTyping(e)),this.els.container.addEventListener("click",e=>{"GAME_TYPING"===this.gameState&&this.els.input.focus()}),document.addEventListener("keydown",e=>{"GAME_TYPING"===this.gameState&&this.els.input.focus()})),this.preloadAssets(),this.startAnimation(),this.start(),this.updateDisplay(),this.playPetBGM()}unlockAudio(){this.audioUnlocked||(this.audioUnlocked=!0,this.currentBGM&&this.currentBGM.paused&&this.audioSettings.bgm&&this.currentBGM.play().catch(e=>{}))}playBGM(e){e&&(this.currentBGMUrl===e?this.currentBGM&&this.currentBGM.paused&&this.audioSettings.bgm&&this.audioUnlocked&&this.currentBGM.play():(this.currentBGM&&(this.currentBGM.pause(),this.currentBGM=null),this.currentBGMUrl=e,this.currentBGM=new Audio(e),this.currentBGM.loop=!0,this.currentBGM.volume=.15,this.audioUnlocked&&this.audioSettings.bgm&&this.currentBGM.play().catch(e=>{})))}playSFX(e){this.audioUnlocked&&this.audioSettings.sfx&&(e=this.sfxData[e])&&((e=new Audio(e)).volume=.3,e.play().catch(e=>{}))}toggleBGM(){this.audioSettings.bgm=!this.audioSettings.bgm,this.audioSettings.bgm?this.currentBGM?this.currentBGM.play():this.playPetBGM():this.currentBGM&&this.currentBGM.pause(),this.playSFX("button")}toggleSFX(){this.audioSettings.sfx=!this.audioSettings.sfx,this.playSFX("button")}preloadAssets(){let s=[];this.skins.forEach(e=>s.push(e)),this.petLines.forEach(t=>{Object.keys(t.tree).forEach(e=>{t.tree[e].forEach(e=>{e.images&&e.images.forEach(e=>s.push(e))})})}),this.maps.forEach(e=>{e.background&&e.background.includes("url")&&(e=e.background.match(/url\(['"]?(.*?)['"]?\)/))&&e[1]&&s.push(e[1])}),s.forEach(e=>{(new Image).src=e})}startAnimation(){this.animationInterval&&clearInterval(this.animationInterval),this.animationInterval=setInterval(()=>{this.toggleFrame()},500)}toggleFrame(){var e;this.frameIndex=0===this.frameIndex?1:0,"MENU_PET"===this.gameState?(e=this.getPreviewImages(this.petSelectionIndex))&&(this.els.img.src=e[this.frameIndex]):"GAME_VS"===this.gameState?(this.els.vsPlayer.src=this.currentPhaseImages[this.frameIndex],this.currentEnemy&&this.currentEnemy.images&&(this.els.vsEnemy.src=this.currentEnemy.images[this.frameIndex])):this.els.img.src=this.currentPhaseImages[this.frameIndex]}getPreviewImages(e){var t=this.petLines[e].tree;for(let e=this.phases.length-1;0<=e;e--){var s=this.phases[e];if(t[s]&&0<t[s].length)return t[s][0].images}return null}handleRightTopInput(){if(this.playSFX("button"),this.evolutionPending)this.triggerEvolution();else if(!this.isMenuAnimating)switch(this.gameState){case"GAME":this.enterMenu();break;case"MENU_MAIN":0===this.menuIndex?this.enterMapSelect():1===this.menuIndex?this.enterPetMenu():2===this.menuIndex?this.startTypingGame(!0):3===this.menuIndex?this.enterSkinMenu():4===this.menuIndex&&this.enterSoundMenu();break;case"MENU_SOUND":0===this.soundMenuIndex?(this.toggleBGM(),this.updateSoundMenuDisplay()):1===this.soundMenuIndex?(this.toggleSFX(),this.updateSoundMenuDisplay()):this.enterMenu();break;case"MENU_MAP":this.enterLevelSelect();break;case"MENU_LEVEL":this.tryEnterBattle();break;case"GAME_VS":this.startBattleGame();break;case"MENU_SKIN":this.applySkin(this.skinSelectionIndex),this.exitMenu();break;case"MENU_PET":this.applyPet(this.petSelectionIndex),this.exitMenu()}}handleUpInput(){if(this.playSFX("button"),!this.isMenuAnimating&&"GAME_TYPING"!==this.gameState)switch(this.gameState){case"MENU_MAIN":this.navigateMenu(-1,"menuIndex",this.menuOptions);break;case"MENU_SOUND":this.soundMenuIndex--,this.soundMenuIndex<0&&(this.soundMenuIndex=2),this.updateSoundMenuDisplay();break;case"MENU_MAP":this.navigateMenu(-1,"selectedMapIndex",this.maps.map(e=>e.name));break;case"MENU_LEVEL":this.navigateLevel(-1);break;case"MENU_SKIN":this.navigateMenu(-1,"skinSelectionIndex",this.skinNames);break;case"MENU_PET":this.petSelectionIndex--,this.petSelectionIndex<0&&(this.petSelectionIndex=this.petLines.length-1),this.updatePetMenuDisplay()}}handleDownInput(){if(this.playSFX("button"),!this.isMenuAnimating&&"GAME_TYPING"!==this.gameState)switch(this.gameState){case"MENU_MAIN":this.navigateMenu(1,"menuIndex",this.menuOptions);break;case"MENU_SOUND":this.soundMenuIndex++,2<this.soundMenuIndex&&(this.soundMenuIndex=0),this.updateSoundMenuDisplay();break;case"MENU_MAP":this.navigateMenu(1,"selectedMapIndex",this.maps.map(e=>e.name));break;case"MENU_LEVEL":this.navigateLevel(1);break;case"MENU_SKIN":this.navigateMenu(1,"skinSelectionIndex",this.skinNames);break;case"MENU_PET":this.petSelectionIndex++,this.petSelectionIndex>=this.petLines.length&&(this.petSelectionIndex=0),this.updatePetMenuDisplay()}}handleRightBottomInput(){if(this.playSFX("button"),!this.isMenuAnimating)switch(this.gameState){case"GAME":this.flashMessage("ACTIVE");break;case"MENU_MAIN":this.exitMenu();break;case"MENU_SOUND":case"MENU_SKIN":case"MENU_PET":case"MENU_MAP":this.enterMenu();break;case"MENU_LEVEL":this.enterMapSelect();break;case"GAME_VS":this.exitMenu();break;case"GAME_TYPING":this.finishTypingGame();break;default:this.exitMenu()}}enterSoundMenu(){this.gameState="MENU_SOUND",this.soundMenuIndex=0,this.updateSoundMenuDisplay()}updateSoundMenuDisplay(){let e="";e=0===this.soundMenuIndex?"BGM: "+(this.audioSettings.bgm?"ON":"OFF"):1===this.soundMenuIndex?"SFX: "+(this.audioSettings.sfx?"ON":"OFF"):"EXIT",this.els.menuOverlay.style.display="flex",this.els.menuOverlay.innerHTML=`<div class="menu-bar"><div class="menu-text">${e}</div></div>`}enterMapSelect(){this.gameState="MENU_MAP",this.selectedMapIndex=0,this.els.img.style.display="none",this.renderStaticBar(this.maps[0].name),this.updateMapStatusDisplay(),this.maps[0].bgm&&this.playBGM(this.maps[0].bgm)}updateMapStatusDisplay(){var e=this.maps[this.selectedMapIndex];this.els.time.innerText=e.isUnlocked?"UNLOCKED":"LOCKED",this.els.msg.innerText="SELECT MAP",this.els.screen.style.background=e.background,this.els.screen.style.backgroundSize="cover",this.els.screen.style.backgroundPosition="center",e.bgm&&this.playBGM(e.bgm)}enterLevelSelect(){this.maps[this.selectedMapIndex].isUnlocked?(this.gameState="MENU_LEVEL",this.selectedLevelIndex=0,this.els.menuOverlay.style.display="none",this.renderMapPins(),this.updateLevelInfo()):this.flashMessage("LOCKED!")}renderMapPins(){document.querySelectorAll(".map-pin").forEach(e=>e.remove()),this.maps[this.selectedMapIndex].levels.forEach((e,t)=>{var s=document.createElement("div");s.className="map-pin",s.style.left=e.x+"%",s.style.top=e.y+"%",e.isCleared?s.classList.add("cleared"):e.isUnlocked&&s.classList.add("unlocked"),t===this.selectedLevelIndex&&s.classList.add("selected"),this.els.screen.appendChild(s)})}navigateLevel(e){var t=this.maps[this.selectedMapIndex];this.selectedLevelIndex+=e,this.selectedLevelIndex>=t.levels.length&&(this.selectedLevelIndex=0),this.selectedLevelIndex<0&&(this.selectedLevelIndex=t.levels.length-1),this.renderMapPins(),this.updateLevelInfo()}updateLevelInfo(){var e=this.maps[this.selectedMapIndex].levels[this.selectedLevelIndex];this.els.time.innerText=e.name,this.els.msg.innerText="PHASE: "+e.phase}tryEnterBattle(){var e=this.maps[this.selectedMapIndex].levels[this.selectedLevelIndex];e.isUnlocked||e.isCleared?this.currentPhaseIndex<e.phase?this.flashMessage("TOO WEAK!"):(this.currentEnemy=this.findEnemyData(e.enemyId),this.currentEnemy||(this.currentEnemy={images:["",""]}),this.gameState="GAME_VS",this.els.vsScreen.style.display="flex",this.els.time.innerText="",this.els.msg.innerText="BATTLE!",this.frameIndex=0):this.flashMessage("LOCKED")}findEnemyData(t){for(var e of this.petLines)for(var s in e.tree){s=e.tree[s].find(e=>e.id===t);if(s)return s}return null}startBattleGame(){var e=this.maps[this.selectedMapIndex].levels[this.selectedLevelIndex];this.els.vsScreen.style.display="none",this.startTypingGame(!1,e.difficulty||{wpm:10})}resolveBattle(e){this.gameState="MENU_LEVEL",this.playSFX(e?"win":"lose"),e?(this.flashMessage("WIN!"),(e=this.maps[this.selectedMapIndex]).levels[this.selectedLevelIndex].isCleared=!0,this.selectedLevelIndex+1<e.levels.length?e.levels[this.selectedLevelIndex+1].isUnlocked=!0:(this.flashMessage("MAP CLEAR!"),this.selectedMapIndex+1<this.maps.length&&(this.maps[this.selectedMapIndex+1].isUnlocked=!0))):this.flashMessage("LOSE..."),this.renderMapPins()}startTypingGame(e=!0,t=null){this.gameState="GAME_TYPING",this.els.menuOverlay.style.display="none",this.els.msg.innerText="READY...",this.isTrainingMode=e,this.battleDifficulty=t,this.els.input.value="",this.els.input.focus(),this.typingCorrectChars=0,this.typingTotalChars=0,this.typingTimer=20,this.typingIndex=0,this.generateRandomWord()}generateRandomWord(){var e,t;"GAME_TYPING"===this.gameState&&(this.typingIndex=0,e=this.wordParts[Math.floor(Math.random()*this.wordParts.length)],t=this.wordParts[Math.floor(Math.random()*this.wordParts.length)],this.typingTarget=.3<Math.random()?e+t:e,this.els.time.innerText=this.typingTarget,this.els.msg.innerText="_".repeat(this.typingTarget.length))}handleTyping(e){if("GAME_TYPING"===this.gameState){var t=this.els.input.value;if(t){t=t.slice(-1).toUpperCase();if(this.els.input.value="",t.match(/[a-zA-Z]/i)){var s=this.typingTarget[this.typingIndex];if(this.typingTotalChars++,t===s){this.typingCorrectChars++,this.typingIndex++;t=this.typingTarget.substring(0,this.typingIndex),s="_".repeat(this.typingTarget.length-this.typingIndex);this.els.msg.innerText=t+s,this.typingIndex>=this.typingTarget.length&&(this.els.time.innerText="OK!",this.els.msg.innerText="",setTimeout(()=>{this.generateRandomWord()},100))}else{let e=this.els.msg.innerText;this.els.msg.innerText="ERR",setTimeout(()=>{"GAME_TYPING"===this.gameState&&(this.els.msg.innerText=e)},100)}}}}}finishTypingGame(){this.els.input.blur();var e=this.typingCorrectChars/5/(20/60);let t=0;0<this.typingTotalChars&&(t=Math.floor(this.typingCorrectChars/this.typingTotalChars*100)),this.isTrainingMode?(this.petStats.wpm=Math.floor(e),this.petStats.accuracy=t,this.gameState="GAME",this.els.time.innerText="WPM:"+this.petStats.wpm,this.els.msg.innerText=`ACC:${this.petStats.accuracy}%`,setTimeout(()=>{this.updateDisplay()},3e3)):(e=e>=(this.battleDifficulty?this.battleDifficulty.wpm:10),this.resolveBattle(e))}checkEvolution(){if(!this.evolutionPending&&this.currentDigimon.next&&0!==this.currentDigimon.next.length){var e=this.totalSeconds-this.timeAtLastEvolution,t=this.phases[this.currentPhaseIndex];if(!(this.currentPhaseIndex>=this.phases.length-1||e<this.requirements[t])){e=this.phases[this.currentPhaseIndex+1];let s=this.currentTree[e];this.currentDigimon.next.some(t=>{var e=s.find(e=>e.id===t);return!(!e||e.conditions&&(e.conditions.minWPM&&this.petStats.wpm<e.conditions.minWPM||e.conditions.minAccuracy&&this.petStats.accuracy<e.conditions.minAccuracy||e.conditions.maxAccuracy&&this.petStats.accuracy>e.conditions.maxAccuracy))})&&this.showEvolutionPrompt()}}}showEvolutionPrompt(){this.evolutionPending=!0,this.els.modal.style.display="flex"}triggerEvolution(){this.els.modal.style.display="none",this.evolutionPending=!1;var t=this.currentDigimon.next;if(t&&0!==t.length){var s=this.phases[this.currentPhaseIndex+1];let e=this.currentTree[s];s=t.map(t=>e.find(e=>e.id===t)).filter(e=>e).filter(e=>!e.conditions||!(e.conditions.minWPM&&this.petStats.wpm<e.conditions.minWPM||e.conditions.minAccuracy&&this.petStats.accuracy<e.conditions.minAccuracy||e.conditions.maxAccuracy&&this.petStats.accuracy>e.conditions.maxAccuracy));0!==s.length&&(s.sort((e,t)=>{e=e.conditions&&e.conditions.minWPM?e.conditions.minWPM:0;return(t.conditions&&t.conditions.minWPM?t.conditions.minWPM:0)-e}),t=s[0],this.currentPhaseIndex++,this.currentDigimon=t,this.currentPhaseImages=this.currentDigimon.images,this.timeAtLastEvolution=this.totalSeconds,this.frameIndex=0,this.petStats={wpm:0,accuracy:0},this.els.img.src=this.currentPhaseImages[0],this.flashMessage("EVOLVED!"),this.playSFX("evolve"))}}tick(){"GAME_TYPING"===this.gameState?0<this.typingTimer&&(this.typingTimer--,0===this.typingTimer)&&this.finishTypingGame():"GAME"===this.gameState&&(this.totalSeconds++,this.updateDisplay(),this.checkEvolution())}navigateMenu(e,t,s){let i=this[t]+e;(i=i>=s.length?0:i)<0&&(i=s.length-1),this[t]=i,this.animateBarTransition(s[this[t]-e<0?s.length-1:(this[t]-e)%s.length],s[i],e),"MENU_SKIN"===this.gameState&&(this.els.container.style.backgroundImage=`url('${this.skins[this[t]]}')`),"MENU_MAP"===this.gameState&&this.updateMapStatusDisplay()}animateBarTransition(e,t,s){this.isMenuAnimating=!0;let i=document.querySelector(".menu-bar");var n;i&&(i.innerHTML="",(n=document.createElement("div")).className="menu-text",n.innerText=e,(e=document.createElement("div")).className="menu-text",e.innerText=t,1===s?(n.classList.add("slide-out-up"),e.classList.add("slide-in-up")):(n.classList.add("slide-out-down"),e.classList.add("slide-in-down")),i.appendChild(n),i.appendChild(e),setTimeout(()=>{this.isMenuAnimating=!1,i.innerHTML=`<div class="menu-text">${t}</div>`},200))}renderStaticBar(e){this.els.menuOverlay.style.display="flex",this.els.menuOverlay.innerHTML=`<div class="menu-bar"><div class="menu-text">${e}</div></div>`}enterMenu(){this.gameState="MENU_MAIN",this.menuIndex=0,this.renderStaticBar(this.menuOptions[0]),this.els.msg.innerText="",this.els.time.innerText=""}enterSkinMenu(){this.gameState="MENU_SKIN",this.skinSelectionIndex=0,this.renderStaticBar(this.skinNames[0]),this.els.container.style.backgroundImage=`url('${this.skins[0]}')`}enterPetMenu(){this.gameState="MENU_PET",this.petSelectionIndex=this.currentPetIndex,this.updatePetMenuDisplay()}exitMenu(){this.gameState="GAME",this.els.menuOverlay.style.display="none",this.els.vsScreen.style.display="none",document.querySelectorAll(".map-pin").forEach(e=>e.remove()),this.els.screen&&(this.els.screen.style.background=""),this.els.container.style.background="",this.els.img.style.display="block",this.applySkin(this.skinSelectionIndex),this.updateDisplay(),this.frameIndex=0,this.toggleFrame(),this.playPetBGM()}updatePetMenuDisplay(){this.els.menuOverlay.style.display="none",this.els.time.innerText="PICK EGG:",this.els.msg.innerText="> "+this.petLines[this.petSelectionIndex].name;var e=this.getPreviewImages(this.petSelectionIndex);e&&(this.frameIndex=0,this.els.img.src=e[0])}applySkin(e){this.els.container.style.backgroundImage=`url('${this.skins[e]}')`,this.flashMessage("SKIN SET!")}applyPet(e){e!==this.currentPetIndex?(this.currentPetIndex=e,this.currentTree=this.petLines[e].tree,this.currentDigimon=this.currentTree.PHASE_0[0],this.currentPhaseImages=this.currentDigimon.images,this.currentPhaseIndex=0,this.totalSeconds=0,this.timeAtLastEvolution=0,this.petStats={wpm:0,accuracy:0},this.flashMessage("NEW EGG!"),this.playPetBGM()):this.flashMessage("NO CHANGE")}start(){this.timerInterval&&clearInterval(this.timerInterval),this.isPlaying=!0,this.timerInterval=setInterval(()=>{this.tick()},1e3)}stop(){this.isPlaying=!1,this.els.msg.innerText="PAUSED",clearInterval(this.timerInterval)}updateDisplay(){var e,t,s,i,n;"GAME"===this.gameState&&(e=Math.floor(this.totalSeconds/60),t=this.totalSeconds%60,s=this.currentDigimon.id?this.currentDigimon.id.toUpperCase():"DIGIMON",this.currentDigimon.next&&0!==this.currentDigimon.next.length?(i=this.totalSeconds-this.timeAtLastEvolution,n=this.phases[this.currentPhaseIndex],n=this.requirements[n],this.els.msg.innerText=n<=i&&this.totalSeconds%2==0?"TIME TO TRAIN!":s):this.els.msg.innerText=this.totalSeconds%2==0?"MAX LEVEL":s,this.els.time.innerText=`T: ${e}:`+t.toString().padStart(2,"0"))}flashMessage(e){this.els.msg.innerText;this.els.msg.innerText=e,setTimeout(()=>{var e;"GAME"===this.gameState&&(e=!this.currentDigimon.next||0===this.currentDigimon.next.length,this.els.msg.innerText=e?"MAX LEVEL":"ACTIVE")},1500)}}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("digimon-container")&&new e})})();